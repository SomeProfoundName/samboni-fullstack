---
import ProductCard from "./ProductCard.astro";
import {
  getShopifyCollections,
  type ShopifyCollection,
} from "../util/getShopifyCollections";
import {
  getCollectionProducts,
  type ShopifyProduct,
} from "../util/getCollectionProducts";

const collections = await getShopifyCollections();

// Fetch products for all collections
const collectionProducts: Record<string, ShopifyProduct[]> = {};
for (const collection of collections) {
  collectionProducts[collection.handle] = await getCollectionProducts(
    collection.handle
  );
}
---

<section class="w-screen h-screen bg-green">
  <div class="container">
    <h1 class="text-2xl sm:text-2xl md:text-6xl">Store</h1>
    <hr class="mx-1"/>

    <div role="tablist" class="tabs tabs-border">
      {
        collections.map((collection: ShopifyCollection, index: number) => (
          <a
            role="tab"
            class={index === 0 ? "tab tab-active" : "tab"}
            data-handle={collection.handle}
          >
            {collection.title}
          </a>
        ))
      }
    </div>

    <!-- Render products for each collection -->
    {
      collections.map((collection: ShopifyCollection, index: number) => {
        const products = collectionProducts[collection.handle] || [];
        return (
          <div
            id={`collection-${collection.handle}`}
            class={`mt-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-4 ${index !== 0 ? "hidden" : ""}`}
          >
            {products.length > 0 ? (
              products.map((product) => {
                const imageUrl = product.images?.edges?.[0]?.node?.url || "";
                const imageAlt =
                  product.images?.edges?.[0]?.node?.altText || product.title;
                const variant = product.variants?.edges?.[0]?.node;
                const variantId = variant?.id || "";
                const availableForSale = variant?.availableForSale ?? true;

                return (
                  <ProductCard
                    title={product.title}
                    image={imageUrl}
                    imageAlt={imageAlt}
                    description={product.description}
                    variantId={variantId}
                    availableForSale={availableForSale}
                  />
                );
              })
            ) : (
              <p class="col-span-full text-center">
                No products found in this collection
              </p>
            )}
          </div>
        );
      })
    }
  </div>
</section>

<script>
  document.querySelectorAll('[role="tab"]').forEach((tab) => {
    tab.addEventListener("click", (e) => {
      const handle = (e.target as HTMLElement).dataset.handle;

      if (!handle) return;

      document
        .querySelectorAll('[role="tab"]')
        .forEach((t) => t.classList.remove("tab-active"));
      (e.target as HTMLElement).classList.add("tab-active");

      document.querySelectorAll('[id^="collection-"]').forEach((container) => {
        container.classList.add("hidden");
      });
      document
        .getElementById(`collection-${handle}`)
        ?.classList.remove("hidden");
    });
  });
</script>
