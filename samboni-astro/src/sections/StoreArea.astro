---
import ProductCard from "../components/ProductCard.astro";
import {
  getShopifyCollections,
  type ShopifyCollection,
} from "../util/getShopifyCollections";
import {
  getCollectionProducts,
  type ShopifyProduct,
} from "../util/getCollectionProducts";

const collections = await getShopifyCollections();

// Fetch products for all collections
const collectionProducts: Record<string, ShopifyProduct[]> = {};
for (const collection of collections) {
  collectionProducts[collection.handle] = await getCollectionProducts(
    collection.handle,
  );
}
---

<section class="w-full h-auto top-spacing" id="Store">
  <div class="container">
    <h1 class="text-2xl sm:text-2xl md:text-6xl border-b pb-2">Store</h1>

    <div class="w-full h-80 top-spacing relative">
      <p class="absolute text-xl md:text-3xl w-full left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-center text-base-content font-black md:no-wrap">SHOP SAMBONI'S SELECTION OF COFFEE</p>
      <img src="/images/samboni-coffee.png" class="w-full h-full object-cover border-4 border-base-300" alt="" />
    </div>

    <div role="tablist" class="tabs tabs-border mt-1">
      {
        collections.map((collection: ShopifyCollection, index: number) => (
          <a
            role="tab"
            class={index === 0 ? "tab tab-active " : "tab"} 
            data-handle={collection.handle}
          >
            {collection.title} 
          </a>
        ))
      }
    </div>

    <!-- Render products for each collection -->
    {
      collections.map((collection: ShopifyCollection, index: number) => {
        const products = collectionProducts[collection.handle] || [];
        return (
          <div
            id={`collection-${collection.handle}`}
            class={`mt-6 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 ${index !== 0 ? "hidden" : ""}`}
          >
            {products.length > 0 ? (
              products.map((product) => {
                const imageUrl = product.images?.edges?.[0]?.node?.url || "";
                const imageAlt =
                  product.images?.edges?.[0]?.node?.altText || product.title;
                const variant = product.variants?.edges?.[0]?.node;
                const variantId = variant?.id || "";
                const availableForSale = variant?.availableForSale ?? true;
                const quantityAvailable = variant?.quantityAvailable ?? 0;

                return (
                  <ProductCard
                    title={product.title}
                    image={imageUrl}
                    imageAlt={imageAlt}
                    description={product.description}
                    variantId={variantId}
                    availableForSale={availableForSale}
                    quantityAvailable={quantityAvailable}
                    handle={product.handle}
                  />
                );
              })
            ) : (
              <p class="col-span-full text-center">
                No products found in this collection
              </p>
            )}
          </div>
        );
      })
    }
  </div>
</section>

<script>
  document.querySelectorAll('[role="tab"]').forEach((tab) => {
    tab.addEventListener("click", (e) => {
      const handle = (e.target as HTMLElement).dataset.handle;

      if (!handle) return;

      document
        .querySelectorAll('[role="tab"]')
        .forEach((t) => t.classList.remove("tab-active"));
      (e.target as HTMLElement).classList.add("tab-active");

      document.querySelectorAll('[id^="collection-"]').forEach((container) => {
        container.classList.add("hidden");
      });
      document
        .getElementById(`collection-${handle}`)
        ?.classList.remove("hidden");
    });
  });
</script>
